<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blink — Beheer</title>
  <style>
    body{font:16px/1.6 system-ui,sans-serif;margin:0;padding:1rem;background:#F7FAFF;color:#0B0F16}
    .container{max-width:900px;margin:auto;background:white;padding:1rem;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .btn{background:#1F6FEB;color:white;padding:.5rem 1rem;border:0;border-radius:8px;cursor:pointer;margin:.2rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{border-bottom:1px solid #ccc;padding:.5rem;text-align:left}
  </style>
</head>
<body>
<div class="container">
  <h1>Blink — Beheer</h1>
  <p>Vink zaterdagen aan/uit en klik op <b>⬆️ Opslaan naar GitHub</b>.</p>

  <label>GitHub Token <input id="ghToken" type="password" style="width:100%"></label>
  <button class="btn" id="saveCfg">Bewaar token in browser</button>

  <table id="satTable">
    <thead><tr><th>Datum</th><th>Beschikbaar</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>

  <button class="btn" id="saveSat">Opslaan (lokaal)</button>
  <button class="btn" id="pushGitHub">⬆️ Opslaan naar GitHub</button>
</div>

<script>
  const SAT_KEY='blink-saturday-availability',BOOKED_KEY='blink-saturday-booked',CFG_KEY='blink-ghcfg';
  function ymd(d){return d.toISOString().slice(0,10);}
  function* saturdays(years=2){const d=new Date();d.setHours(0,0,0,0);const end=new Date(d);end.setFullYear(end.getFullYear()+years);d.setDate(d.getDate()+((6-d.getDay()+7)%7));while(d<=end){yield new Date(d);d.setDate(d.getDate()+7);}}

  function renderSatTable(){
    const tb=document.querySelector('#satTable tbody');tb.innerHTML='';
    const availability=JSON.parse(localStorage.getItem(SAT_KEY)||'{}');
    const booked=JSON.parse(localStorage.getItem(BOOKED_KEY)||'{}');
    for(const d of saturdays(2)){
      const id=ymd(d),avail=availability[id]??true,isBooked=!!booked[id];
      tb.innerHTML+=`<tr><td>${id}</td><td><input type="checkbox" ${avail?'checked':''} ${isBooked?'disabled':''} data-date="${id}"></td><td>${isBooked?'Geboekt':(avail?'Open':'Geblokkeerd')}</td></tr>`;
    }
  }
  renderSatTable();

  document.getElementById('saveSat').onclick=()=>{
    const availability={};
    document.querySelectorAll('#satTable input').forEach(cb=>availability[cb.dataset.date]=cb.checked);
    localStorage.setItem(SAT_KEY,JSON.stringify(availability));
    alert('Beschikbaarheid lokaal opgeslagen');
  };

  // GitHub API upload
  function b64(str){return btoa(unescape(encodeURIComponent(str)));}
  async function ghPutFile(token,content){
    const url='https://api.github.com/repos/larsvdvelden/blink-site/contents/availability.json';
    let sha=null;
    const res1=await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
    if(res1.status===200){const j=await res1.json(); sha=j.sha;}
    const body={message:"Update availability",content:b64(content),branch:"main"};
    if(sha) body.sha=sha;
    const res=await fetch(url,{method:"PUT",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},body:JSON.stringify(body)});
    if(!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  document.getElementById('pushGitHub').onclick=async()=>{
    const token=localStorage.getItem(CFG_KEY)||document.getElementById('ghToken').value;
    if(!token) return alert("Vul token in");
    const availability=JSON.parse(localStorage.getItem(SAT_KEY)||'{}');
    const booked=JSON.parse(localStorage.getItem(BOOKED_KEY)||'{}');
    const data={generatedAt:new Date().toISOString(),availability,booked};
    try{await ghPutFile(token,JSON.stringify(data,null,2));alert("Upload naar GitHub gelukt");}catch(e){alert("Fout: "+e.message);}
  };
  document.getElementById('saveCfg').onclick=()=>{
    const token=document.getElementById('ghToken').value;
    if(token){localStorage.setItem(CFG_KEY,token);alert("Token opgeslagen in browser");}
  };
</script>
</body>
</html>
